{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ðŸ“… Daily Closings</h2>
  </div>
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body py-4">
      <form method="POST" action="{{ url_for('daily_close') }}" class="text-center">
        <div class="row justify-content-center g-4">

          <!-- Sales Input -->
          <div class="col-md-3 col-sm-6">
            <label for="sales" class="form-label text-muted fw-semibold fs-6">Today's Sales (USD)</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-light fw-bold">$</span>
              <input type="number" name="sales" id="sales"
                class="form-control text-center display-5 fw-bold py-3 sale-input" min="0" step="0.01"
                placeholder="0.00" required autofocus>
            </div>
          </div>

          <!-- Date Input -->
          <div class="col-md-3 col-sm-6">
            <label for="date" class="form-label text-muted fw-semibold fs-6">Closing Date</label>
            <input type="date" name="date" id="date" class="form-control text-center fs-4 fw-semibold py-3 date-input"
              value="{{ today.isoformat() }}" required>
          </div>

          <!-- Notes Input -->
          <a class="small text-muted d-block mt-2" data-bs-toggle="collapse" href="#collapseNotes">
            + Add optional note
          </a>
          <div class="collapse mt-2" id="collapseNotes">
            <input type="text" name="notes" id="notes" class="form-control fs-5 fw-normal py-3"
              placeholder="e.g., Low stock day, partial card delay">
          </div>

          <!-- Submit -->
          <div class="col-md-2 col-sm-6 d-flex align-items-end">
            <button type="submit" class="btn btn-success btn-lg w-100 py-3 fw-bold">
              Submit
            </button>
          </div>

        </div>
      </form>
    </div>
  </div>


  <table class="table table-bordered bg-white shadow-sm">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>Sales</th>
        <th>Fixed Expenses</th>
        <th>Operations</th>
        <th>Restock</th>
        <th>Buffer</th>
        <th>Notes</th>
        <th style="width: 120px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for c in closings %}
      <tr>
        <td>{{ c.date }}</td>
        <td>${{ "%.2f"|format(c.sales_cents / 100) }}</td>
        <td>${{ "%.2f"|format(c.fixed_allocation_cents / 100) }}</td>
        <td>${{ "%.2f"|format(c.ops_allocation_cents / 100) }}</td>
        <td>${{ "%.2f"|format(c.inventory_allocation_cents / 100) }}</td>
        <td>
          <span
            class="badge bg-{% if c.buffer_allocation_cents / c.sales_cents >= 0.4 %}success{% elif c.buffer_allocation_cents / c.sales_cents >= 0.2 %}warning{% else %}danger{% endif %}">
            ${{ "%.2f"|format(c.buffer_allocation_cents / 100) }}
          </span>
        </td>
        <td class="text-start small text-muted">{{ c.notes or "-" }}</td>
        <td class="text-center">
          <!-- Edit Button -->
          <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editClosingModal"
            data-id="{{ c.id }}" data-date="{{ c.date }}" data-sales="{{ c.sales_cents / 100 }}"
            data-notes="{{ c.notes or '' }}">
            <i class="bi bi-pencil-square"></i>
          </button>

          <!-- Delete Button -->
          <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteClosingModal"
            data-id="{{ c.id }}" data-date="{{ c.date }}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">No closings found</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot class="table-light fw-bold">
      <tr>
        <td>Total</td>
        <td>
          ${{ '%.2f' % ((closings | sum(attribute='sales_cents', start=0)) / 100) }}
        </td>
        <td>
          ${{ '%.2f' % ((closings | sum(attribute='fixed_allocation_cents', start=0)) / 100) }}
        </td>
        <td>
          ${{ '%.2f' % ((closings | sum(attribute='ops_allocation_cents', start=0)) / 100) }}
        </td>
        <td>
          ${{ '%.2f' % ((closings | sum(attribute='inventory_allocation_cents', start=0)) / 100) }}
        </td>
        <td>
          ${{ '%.2f' % ((closings | sum(attribute='buffer_allocation_cents', start=0)) / 100) }}
        </td>
      </tr>
    </tfoot>
  </table>
</div>
<!-- Edit Closing Modal -->
<div class="modal fade" id="editClosingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="editClosingForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Closing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="closing_id" id="editClosingId">

          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="text" id="editDate" class="form-control bg-light" readonly>
          </div>

          <div class="mb-3">
            <label for="editSale" class="form-label">Sales ($)</label>
            <input type="number" step="0.01" name="sale" id="editSale" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="editNotes" class="form-label">Notes</label>
            <textarea name="notes" id="editNotes" class="form-control" rows="2"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteClosingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <form method="POST" id="deleteClosingForm">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-1">Youâ€™re about to <strong>delete</strong> the closing for:</p>
          <p class="fw-bold fs-5 mb-0" id="deleteClosingDate">â€”</p>
          <p class="text-muted small mb-0 mt-3">This will also reverse all envelope allocations for that date.</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger fw-semibold">Delete Closing</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}