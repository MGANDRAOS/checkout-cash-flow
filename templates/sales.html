{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/simple-chat-ui@0.1.2-beta.2/index.css" rel="stylesheet">

<div class="container-fluid py-3">

  <!-- Header Row -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0 fw-semibold">
      <i class="bi bi-cash-stack me-2"></i>POS Sales Dashboard
    </h5>
    <div class="d-flex gap-2">
      <input id="salesDate" type="date" class="form-control form-control-sm" value="{{ today }}"
        title="Data for today is finalized tomorrow morning.">
      <div id="weatherBadge" class="small text-muted d-flex align-items-center gap-1"></div>
      <button id="salesRefresh" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-repeat"></i>
      </button>
    </div>

  </div>

  <!-- KPIs Row -->
  <div class="row g-3 mb-4" id="salesKPI">
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Total Sales</div>
          <div class="fw-bold fs-6" id="kpiTotalSales">–</div>
          <div class="fw-bold fs-6" id="kpiTotalSalesUSD">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Receipts</div>
          <div class="fw-bold fs-6" id="kpiReceipts">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Avg Ticket</div>
          <div class="fw-bold fs-6" id="kpiAvgTicket">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Vs Yesterday</div>
          <div class="fw-bold fs-6" id="kpiGrowthYesterday">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Vs 4-Week Avg</div>
          <div class="fw-bold fs-6" id="kpiGrowth4W">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card text-center shadow-sm">
        <div class="card-body py-3">
          <div class="text-muted small">Peak Hour</div>
          <div class="fw-bold fs-6" id="kpiPeakHour">–</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Last 14 Days Sales Trend -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold"><i class="bi bi-calendar3 me-1"></i>Last 14 Days Sales Trend</span>
    </div>
    <div class="card-body">
      <canvas id="chartDaily14Days" height="100"></canvas>
      <div id="summaryDaily14Days" class="ai-summary small text-muted mt-2 fst-italic">
        <i class="bi bi-stars me-1 text-primary"></i>
        <span class="ai-text">AI-generated summary will appear here.</span>
      </div>
    </div>
  </div>


  <!-- Sales Trends Chart -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold"><i class="bi bi-graph-up me-1"></i>Hourly Sales Trend</span>
      <span class="small text-muted">Today vs same weekday past 4 weeks</span>
    </div>
    <div class="card-body">
      <canvas id="chartHourlySales" height="100"></canvas>

      <div id="summaryHourly" class="ai-summary small text-muted mt-2 fst-italic">
        <i class="bi bi-stars me-1 text-primary"></i>
        <span class="ai-text">AI-generated summary will appear here.</span>
      </div>

    </div>
  </div>

  <!-- Hourly Total Sales Trend -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">
        <i class="bi bi-graph-up-arrow me-1"></i>Hourly Total Sales Trend
      </span>
      <span class="small text-muted">Cumulative sales across business hours</span>
    </div>
    <div class="card-body">
      <canvas id="chartHourlyCumulative" height="100"></canvas>
      <div id="summaryHourlyCumulative" class="ai-summary small text-muted mt-2 fst-italic">
        <i class="bi bi-stars me-1 text-primary"></i>
        <span class="ai-text">AI-generated summary will appear here.</span>
      </div>
    </div>
  </div>


  <!-- Category Breakdown -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header fw-semibold">
      <i class="bi bi-diagram-3 me-1"></i>Sales by Category / Subgroup
    </div>
    <div class="card-body">
      <canvas id="chartCategorySales" height="120"></canvas>

      <div id="summaryCategory" class="ai-summary small text-muted mt-2 fst-italic">
        <i class="bi bi-stars me-1 text-primary"></i>
        <span class="ai-text">AI-generated summary will appear here.</span>
      </div>

    </div>
  </div>

  <!-- ===================== ITEMS SOLD SECTION ===================== -->
  <section id="items-sold" class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold">
        Items Sold — <span id="items-date-label">{{ today }}</span>
      </h5>
      <div>
        <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn">
          <i class="bi bi-download"></i> Export CSV
        </button>
      </div>
    </div>

    <!-- Table container -->
    <div id="items-table-wrapper" class="table-responsive shadow-sm rounded">
      <table id="tblItemsSold" class="table table-striped table-hover align-middle w-100"></table>
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Item</th>
          <th>Category</th>
          <th class="text-end">Units</th>
          <th class="text-end">Avg. Price</th>
          <th class="text-end">Revenue</th>
          <th class="text-end">Share</th>
        </tr>
      </thead>
      <tbody id="items-tbody">
        <tr>
          <td colspan="7" class="text-center py-4 text-muted">
            
          </td>
        </tr>
      </tbody>
      <tfoot class="table-light fw-semibold">
        <tr>
          <td colspan="5">Total</td>
          <td class="text-end" id="total-revenue">$0.00</td>
          <td class="text-end">100%</td>
        </tr>
      </tfoot>
      </table>
    </div>
  </section>
  <!-- =================== END ITEMS SOLD SECTION =================== -->


  <!-- Top and Slow Movers -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-semibold">
          <i class="bi bi-trophy me-1"></i>Top 20 Products
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="tblTopProducts" class="table table-sm mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Sales (LBP)</th>
                </tr>
              </thead>
              <tbody id="tblTopProducts">
                <tr>
                  <td colspan="3" class="text-center text-muted small py-3">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-semibold">
          <i class="bi bi-hourglass-split me-1"></i>Slow / Zero Movers (7 days)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="tblSlowProducts" class="table table-sm mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th>Subgroup</th>
                  <th>Last Sold</th>
                </tr>
              </thead>
              <tbody id="tblSlowProducts">
                <tr>
                  <td colspan="3" class="text-center text-muted small py-3">Loading…</td>
                </tr>
              </tbody>
            </table>

            <div id="summarySlow" class="ai-summary small text-muted mt-2 fst-italic">
              <i class="bi bi-stars me-1 text-primary"></i>
              <span class="ai-text">AI-generated summary will appear here.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipts Table -->
  <div class="card shadow-sm">
    <div class="card-header fw-semibold">
      <i class="bi bi-receipt-cutoff me-1"></i>Receipts (Detailed)
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="tblReceipts" class="table table-sm mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Receipt ID</th>
              <th>Time</th>
              <th class="text-end">Items</th>
              <th class="text-end">Total (LBP)</th>
            </tr>
          </thead>
          <tbody id="tblReceipts">
            <tr>
              <td colspan="4" class="text-center text-muted small py-3">Loading…</td>
            </tr>
          </tbody>
        </table>
        <div id="summaryReceipts" class="ai-summary small text-muted mt-2 fst-italic">
          <i class="bi bi-stars me-1 text-primary"></i>
          <span class="ai-text">AI-generated summary will appear here.</span>
        </div>
      </div>
    </div>
  </div>
</div>


{# === Analytics Assistant Widget (Floating Chat) === #}
<!-- This entire block creates the floating chat button and hidden chat window -->
<div id="analyticsWidget" class="analytics-widget collapsed shadow-lg">
  <div class="chat-header d-flex justify-content-between align-items-center px-3 py-2 bg-dark text-white">
    <span class="fw-semibold">Analytics Assistant</span>
    <button class="btn btn-sm btn-outline-light" id="assistantClose">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <!-- Chat container where chat-ui-lite will render -->
  <div id="chat" class="chat-body"></div>
</div>

<!-- Toggle button (floating bubble) -->
<button id="assistantToggle" class="assistant-toggle btn btn-primary rounded-circle shadow">
  <i class="bi bi-chat-dots fs-4"></i>
</button>
{# === /Analytics Assistant Widget === #}


<!-- JS for dynamic charts and data -->
<script src="{{ url_for('static', filename='js/analyticsAssistant.js') }}"></script>
<script src="{{ url_for('static', filename='js/sales.js') }}"></script>

{% endblock %}