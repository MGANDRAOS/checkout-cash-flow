{% extends "base.html" %}
{% block title %}Fixed Collections{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">ðŸ’¼ Fixed Collections Tracker</h2>

    <!-- Progress Bar -->
    <div class="mb-4">
        <h6>Monthly Collection Progress</h6>
        <div class="progress" style="--progress: {{ (progress_pct or 0)|round(2) }}%;">
            <div class="progress-bar {{ 'bg-success' if progress_pct >= 100 else 'bg-info' if progress_pct >= 60 else 'bg-warning' }}"
                style="width: var(--progress);" role="progressbar" aria-valuenow="{{ (progress_pct or 0)|round(1) }}"
                aria-valuemin="0" aria-valuemax="100">
                {{ (progress_pct or 0)|round(1) }}%
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="card bg-light shadow-sm">
                <div class="card-body">
                    <h5>Total Allocated</h5>
                    <h3 class="text-primary">${{ "%.2f"|format(total_allocated / 100) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light shadow-sm">
                <div class="card-body">
                    <h5>Total Collected</h5>
                    <h3 class="text-success">${{ "%.2f"|format(total_collected / 100) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light shadow-sm">
                <div class="card-body">
                    <h5>Outstanding</h5>
                    <h3 class="text-danger">${{ "%.2f"|format(outstanding / 100) }}</h3>
                </div>
            </div>
        </div>
    </div>


    <!-- Collection Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">ðŸ“… Fixed Allocation by Day</h5>
            {% if closings %}
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Fixed Allocation</th>
                            <th>Status</th>
                            <th style="width: 130px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in closings %}
                        {% set collected = collections | selectattr("collected_on", "equalto", c.date) | list %}
                        <tr>
                            <td>{{ c.date.strftime("%a, %d-%m-%Y") }}</td>
                            <td>${{ "%.2f"|format(c.fixed_allocation_cents / 100) }}</td>
                            <td>
                                {% if collected %}
                                <span class="badge bg-success">Collected</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not collected %}
                                <form method="POST" action="{{ url_for('mark_fixed_collected') }}">
                                    <input type="hidden" name="date" value="{{ c.date }}">
                                    <input type="hidden" name="amount" value="{{ c.fixed_allocation_cents }}">
                                    <button type="submit" class="btn btn-sm btn-success w-100">Collect ðŸ’µ</button>
                                </form>
                                {% else %}
                                <button class="btn btn-sm btn-secondary w-100" disabled>Done âœ…</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No daily closings recorded yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}