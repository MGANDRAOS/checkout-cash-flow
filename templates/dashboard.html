{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <!-- Smart Alerts -->
    <div class="mb-3">
        {% if missing_yesterday %}
        <div class="alert alert-warning shadow-sm d-flex justify-content-between align-items-center">
            <div>
                No closing submitted for yesterday ({{ yesterday.strftime('%b %d') }}) ‚Äî click to add.
            </div>
            <a href="#closing-form" class="btn btn-sm btn-outline-warning">Add Closing</a>
        </div>
        {% endif %}

        {% if outstanding_fixed_cents and outstanding_fixed_cents > 0 %}
        <div class="alert alert-info shadow-sm d-flex justify-content-between align-items-center">
            <div>
                You have ${{ outstanding_fixed_dollars }} in Fixed not yet collected.
            </div>
            <a href="{{ url_for('fixed_collections') }}" class="btn btn-sm btn-outline-primary">View Collections</a>
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="d-flex gap-2 mb-4">
        <a href="{{ url_for('fixed_collections') }}" class="btn btn-outline-primary"><i class="bi bi-wallet2"></i> View
            Collections</a>
        <a href="{{ url_for('bills') }}" class="btn btn-outline-primary"><i class="bi bi-receipt"></i> View
            Expenses</a>
    </div>

    <!-- Mini Chart: 7-day Sales vs Buffer -->
    <div class="row g-3">
        <div class="col-lg-8">
            <!-- Chart Container -->
            <div class="card mt-4 shadow-sm">
                <div class="card-body" style="height: 320px;">
                    <canvas id="salesBufferChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Highlight of the Week</h5>
                    <p class="mb-1">Largest sale: <strong>${{ largest_sale_dollars }}</strong>
                        {% if largest_sale_date %} on {{ largest_sale_date.strftime('%a, %b %d') }}{% endif %}
                    </p>
                    <p class="mb-0">7‚Äëday average: <strong>${{ avg_sales_dollars }}</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Data -->
    <script id="chart-data" type="application/json">
        {{ {'labels': chart_labels, 'sales': chart_sales}|tojson|safe }}
    </script>


    <!-- Today's Allocation -->
    {% if last_data %}
    <div class="mb-4">
        <h5 class="mb-2 text-muted">
            üìå Last Recorded Closing ‚Äî {{ last_closing.date.strftime('%B %d, %Y') }}
            <span class="ms-2 badge bg-light text-dark">Sales: ${{ "%.2f"|format(last_closing.sales_cents /
                100)}}</span>
        </h5>

        <div class="row">
            <div class="col-md-3">
                <div class="alert alert-primary shadow-sm">üí∏ Fixed: ${{ "%.2f"|format(last_data.fixed) }}</div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-warning shadow-sm">üõ†Ô∏è Ops: ${{ "%.2f"|format(last_data.ops) }}</div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-info shadow-sm">üì¶ Inventory: ${{ "%.2f"|format(last_data.inventory) }}</div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-success shadow-sm">üß† Buffer: ${{ "%.2f"|format(last_data.buffer) }}</div>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- Envelope Balances -->
    <h4 class="mt-5 mb-3">üí∞ Envelopes</h4>
    <div class="row">
        {% for e in envelopes %}
        <div class="col-md-3 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h5>{{ e.name }}</h5>
                    <p class="fs-4 fw-bold text-success">${{ "%.2f"|format(e.balance_cents / 100) }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Recent Closings -->
    <h4 class="mt-5 mb-3">üìÖ Last 5 Closings</h4>
    <table class="table table-bordered bg-white shadow-sm">
        <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Sales</th>
                <th>Fixed</th>
                <th>Ops</th>
                <th>Inventory</th>
                <th>Buffer</th>
            </tr>
        </thead>
        <tbody>
            {% for c in closings[:5] %}
            <tr>
                <td>{{ c.date }}</td>
                <td>${{ "%.2f"|format(c.sales_cents / 100) }}</td>
                <td>${{ "%.2f"|format(c.fixed_allocation_cents / 100) }}</td>
                <td>${{ "%.2f"|format(c.ops_allocation_cents / 100) }}</td>
                <td>${{ "%.2f"|format(c.inventory_allocation_cents / 100) }}</td>
                <td>${{ "%.2f"|format(c.buffer_allocation_cents / 100) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Fixed Bills Summary -->
    <h4 class="mt-5 mb-3">üìë Fixed Bills</h4>
    <table class="table table-bordered bg-white shadow-sm">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Monthly Amount</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for bill in bills %}
            <tr>
                <td>{{ bill.name }}</td>
                <td>${{ "%.2f"|format(bill.monthly_amount_cents / 100) }}</td>
                <td>
                    {% if bill.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" class="text-center text-muted">No fixed bills yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


</div>
{% endblock %}